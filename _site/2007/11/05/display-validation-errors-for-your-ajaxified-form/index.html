<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
  <meta name="keywords" content="jon maddox richmond programmer ruby cocoa va" />
  <meta name="description" content="Here lies Jon Maddox" />
  <link rel="stylesheet" href="/stylesheets/styles.css" type="text/css"> 
  <link rel="stylesheet" href="/stylesheets/syntax.css" type="text/css"> 
  <title>Display Validation Errors For Your Ajaxified Form</title>
</head>

<body id="post">
<a href="http://github.com/maddox"><img style="position: absolute; top: 0; right: 0; border: 0;" src="http://s3.amazonaws.com/github/ribbons/forkme_right_gray_6d6d6d.png" alt="Fork me on GitHub" /></a>
<div id="content">
  <h1>Display Validation Errors For Your Ajaxified Form</h1>
<p>One of the sweet things Rails provides is practically free error notification on forms. With just a little bit of</p>
<div class="highlight"><pre><span class="o">&lt;%=</span> <span class="n">error_messages_for</span> <span class="ss">:post</span> <span class="o">%&gt;</span>
</pre>
</div><p>validations on your model, and some logic in your controller, bam, instant error messaging. Very simple.</p>
<p>But what if your form is using <span class="caps">AJAX</span> to post? The page doesn&#8217;t re-render, so how is our buddy, <code>error_messages_for</code>, going to work? Well its not, we&#8217;re gonna have to use <span class="caps">AJAX</span> to display the errors. It turns out this isn&#8217;t too touch, but as usual we want to keep it <span class="caps">DRY</span>.</p>
<h3>The Controller</h3>
<div class="highlight"><pre><span class="k">class</span> <span class="nc">PostsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="k">def</span> <span class="nf">create</span>
    <span class="vi">@post</span> <span class="o">=</span> <span class="no">Post</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:post</span><span class="o">]</span><span class="p">)</span>
    <span class="vi">@post</span><span class="o">.</span><span class="n">save!</span>
    
    <span class="c1"># automatically renders create.rjs.erb</span>
  
  <span class="k">rescue</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">RecordInvalid</span>

    <span class="vi">@model</span> <span class="o">=</span> <span class="vi">@kit_item</span>
    <span class="n">render</span> <span class="ss">:template</span> <span class="o">=&gt;</span> <span class="s1">&#39;shared/validation_error.rjs.erb&#39;</span>
  
  <span class="k">end</span>
<span class="k">end</span>
</pre>
</div><p>We will attempt to create the Post. If all goes well, then the <em>create</em> rjs action will fire and all is well. But if the record fails validation, we catch it, assign the current model to <code>@model</code>, and render <em>shared/validaiton_error.rjs.erb</em>. This is our generic <span class="caps">AJAX</span> action for rendering errors for Models.</p>
<h3>The <span class="caps">AJAX</span></h3>
<p>Create <em>shared/validation_error.rjs</em> and use this little snippit, and thats pretty much it for this part.</p>
<div class="highlight"><pre><span class="n">page</span><span class="o">.</span><span class="n">replace_html</span> <span class="s2">&quot;errors_for_</span><span class="si">#{</span><span class="vi">@model</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">underscore</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;Oops! &lt;ul&gt;&quot;</span> <span class="o">+</span> <span class="vi">@model</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">collect</span><span class="p">{</span><span class="o">|</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="o">|</span> <span class="s2">&quot;&lt;li&gt;The </span><span class="si">#{</span><span class="n">k</span><span class="si">}</span><span class="s2"> </span><span class="si">#{</span><span class="n">v</span><span class="si">}</span><span class="s2">&lt;/li&gt;&quot;</span><span class="p">}</span><span class="o">.</span><span class="n">to_s</span> <span class="o">+</span> <span class="s2">&quot;&lt;/ul&gt;&quot;</span>
<span class="n">page</span><span class="o">.</span><span class="n">visual_effect</span> <span class="ss">:highlight</span><span class="p">,</span> <span class="s2">&quot;errors_for_</span><span class="si">#{</span><span class="vi">@model</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">underscore</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="ss">:startcolor</span> <span class="o">=&gt;</span> <span class="s2">&quot;&#39;#ff0000&#39;&quot;</span><span class="p">,</span> <span class="ss">:endcolor</span> <span class="o">=&gt;</span> <span class="s2">&quot;&#39;#aca2b6&#39;&quot;</span>  
</pre>
</div><p>So, the errors just get collected and printed out to a <code>div</code> in the page. Let&#8217;s go add this fancy <code>div</code>.</p>
<h3>The View</h3>
<p>This part is pretty simple. You just need to open up your form partial, <em>posts/_form.html.erb</em> and add this little view helper to the form:</p>
<div class="highlight"><pre><span class="o">&lt;%=</span> <span class="n">error_div_for</span> <span class="n">post</span> <span class="o">%&gt;</span>
</pre>
</div><p>This does nothing but prints out a <code>div</code> with a specific ID to prepare for our <span class="caps">RJS</span> action, if it&#8217;s needed. So let&#8217;s go make the view helper.</p>
<div class="highlight"><pre><span class="k">module</span> <span class="nn">ApplicationHelper</span>

  <span class="k">def</span> <span class="nf">error_div_for</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
      <span class="sx">%{&lt;div id=&quot;errors_for_</span><span class="si">#{</span><span class="n">model</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">underscore</span><span class="si">}</span><span class="sx">&quot;&gt;&lt;/div&gt;}</span>
  <span class="k">end</span>

<span class="k">end</span>
</pre>
</div><p>Now we can just call this simple view helper and pass in any model and it will dynamically build a div with the appropriate ID inside.</p>
<p>And thats pretty much it. To go through it again, when the form is loaded, the error div will be placed in the page, waiting to be used. Once the form is submitted in the background, the controller&#8217;s create action will attempt to save it. If the record is invalid with validation errors, then the universal validation_errror <span class="caps">RJS</span> template will be fired off and replace all the errors from the failed validation, into the div we placed in the page. Oh and of course a little red flash action to make sure the user sees the errors.</p>

  <div id="footer">
    <a href="/">&laquo; Return Home</a>
  </div>
</div>
</body>
</html>
