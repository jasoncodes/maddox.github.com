<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
  <meta name="keywords" content="jon maddox richmond programmer ruby cocoa va" />
  <meta name="description" content="Here lies Jon Maddox" />
  <link rel="stylesheet" href="/stylesheets/styles.css" type="text/css"> 
  <link rel="stylesheet" href="/stylesheets/syntax.css" type="text/css"> 
  <title>Use Capistrano to disable_web On Your PHP Apps</title>
</head>

<body id="posts">
<a href="http://github.com/maddox"><img style="position: absolute; top: 0; right: 0; border: 0;" src="http://s3.amazonaws.com/github/ribbons/forkme_right_gray_6d6d6d.png" alt="Fork me on GitHub" /></a>
<div id="content">
  <h1 class="name">Jon Maddox</h1>
  <h2><a href="/">Home</a></h2>
  <h1>Use Capistrano to disable_web On Your <span class="caps">PHP</span> Apps</h1>
<p>Just like using Capistrano to deploy my Rails apps made my <span class="caps">PHP</span> apps jealous, being able to disable the entire app with a single command did too.</p>
<p>Using a simple <em>cap disable_web</em> command allows my Rails apps to be completely disabled while I perform maintenance on the site without having to worry about users accessing it. Being able to suspend the site with a single command is <strong>wonderful</strong>, trust me.</p>
<p>Well I want to do this with my <span class="caps">PHP</span> apps too. Here&#8217;s how I did it.</p>
<p>First create a generic page that you want your users to see when your site is disabled and name it <em>maintenance.html</em>. Then throw it into your <em>/config</em> directory.</p>
<h3>Cap Tasks</h3>
<p>Next, write a <em>disable_web</em> task for Capistrano.</p>
<div class="highlight"><pre><span class="n">desc</span> <span class="s2">&quot;This will disable the application and show a warning screen&quot;</span>
<span class="n">task</span> <span class="ss">:disable_web</span> <span class="k">do</span>
  <span class="n">run</span> <span class="s2">&quot;cp </span><span class="si">#{</span><span class="n">current_path</span><span class="si">}</span><span class="s2">/config/maintenance.html </span><span class="si">#{</span><span class="n">current_path</span><span class="si">}</span><span class="s2">/maintenance.html&quot;</span>
<span class="k">end</span>
</pre>
</div><p>This simple one liner will copy the maintenance.html file into the root of your application. Now lets write a task to re-enable the application.</p>
<div class="highlight"><pre><span class="n">desc</span> <span class="s2">&quot;This will enable the application and remove the warning screen&quot;</span>
<span class="n">task</span> <span class="ss">:enable_web</span> <span class="k">do</span>
  <span class="n">run</span> <span class="s2">&quot;rm </span><span class="si">#{</span><span class="n">current_path</span><span class="si">}</span><span class="s2">/maintenance.html&quot;</span>
<span class="k">end</span>
</pre>
</div><p>This will simply delete the maintenance file.</p>
<p>Ok, so, basically, when you run <em>cap disable_web</em>, Capistrano will move your maintenance file into the root of your app, and <em>enable_web</em> will delete it. So far this does nothing to disable your <span class="caps">PHP</span> application.</p>
<h3>mod_rewrite Magic</h3>
<p>The trick to this is using mod_rewrite to look for your maintenance file. If it&#8217;s at the root of your application, then all requests will be directed to it. Otherwise the application works as normal.</p>
<div class="highlight"><pre>RewriteEngine On

<span class="c"># Check for maintenance file and redirect all requests</span>
RewriteCond %<span class="o">{</span>DOCUMENT_ROOT<span class="o">}</span>/maintenance.html -f
RewriteCond %<span class="o">{</span>SCRIPT_FILENAME<span class="o">}</span> !maintenance.html
RewriteRule ^.*<span class="o">(</span><span class="se">\.</span>html|<span class="se">\.</span>php<span class="o">)</span><span class="nv">$ </span>/maintenance.html <span class="o">[</span>L<span class="o">]</span>
</pre>
</div><p>This will look for any requests of .html and .php files. All requests that fit that condition will pointed to the maintenance.html page if it exists at the root of the application.</p>
<p>Huzzah! You&#8217;ve now got a &#8220;we&#8217;re fixin&#8217; stuff&#8221; page. <strong>And you can go from this:</strong></p>
<p><img src="http://img.skitch.com/20100102-8iefy1eautujt11jc9c9frfcb8.jpg" class="centered" alt="" /></p>
<p><strong>To this:</strong></p>
<p><img src="http://img.skitch.com/20100102-mw61w28djwhrrxn96qj8ais24e.jpg" class="centered" alt="" /></p>
  <div id="footer">
    <a href="/">&laquo; Return Home</a>
  </div>
</div>
</body>
</html>
